---
layout: post
title: 'Python项目打包和发布简记'
tags: [Other]
categories: [Chinese]
---

最近需要一个可以为视频自动生成字幕的软件，在网络上搜索了很久发现这方面的资源非常少，最后找到最符合需求的开源软件是[autosub](https://github.com/agermanidis/autosub)，但它已经很久没有维护了且甚至不支持Python3，更好用的则是一个疑似国内字幕组团队的[分支](https://github.com/BingLingGroup/autosub)。由于它在Speech-to-Text方面只支持使用谷歌、百度等提供的API（不过似乎谷歌SST可以白嫖所以问题不大），于是我为了整合一个可以离线稳定使用的软件（SST方面使用Mozilla公开的[DeepSpeech](https://github.com/mozilla/DeepSpeech)预训练模型）而开始了工作，大致思路是定位源码中SST的部分加上使用deepspeech模型的功能代码，然后使用工具打包项目。本来以为折腾模型和看源码是最麻烦的，结果事实证明后半部分才是一条不归路。

先说一点闲话，深度学习近年来有了很大的进展，但所有效果好且有实际价值的模型几乎都依赖于大量的数据以及GPU时长的累积，这就造成了对于个人而言想要在软件中享受ai的福利一般来说只能去使用大公司的付费api或者寄希望于别人将自己训练好的模型发布出来。Speech-to-Text也是这样，在谷歌上搜索得到的第一页基本都是谷歌cloud的Speech-to-Text服务（十分真实），DeepSpeech的存在则是在浏览了很多资料之后才知道，其官方的文档也算不上是详细，发布出来的主要用途也是供大家根据自己的需要做finetune，而不是一个out-of-the-box的解决方案。

不管怎么说最后还是用DeepSpeech的预训练模型和API写了一版能用的出来，下一步的问题就是如何打包让它可以方便地分发出去了。原来的作者也折腾着用过`Nuika`和`pyinstaller`打包项目，似乎在踩了很多坑之后还是成功了。因为作者在`README`中对`Nuika`存在的坑较为含糊其辞，于是我尝试了使用`pyinstaller`进行打包，在解决了很多缺失库、错误hook等问题之后，最后卡在了一个`deepspeech`的动态库加载问题上，多次搜索后无果于是选择了放弃。

对于`pyinstaller`失败的问题我想做一个讨论，首先从`pyinstaller`的原理开始讲，从其使用方法可以看出`pyinstaller`打包程序的方法是首先从源码出发做静态分析推断出项目运行需要的库，然后将相关的库文件通过某种方法都打包到一起。`pyinstaller`主要的问题就是静态分析很难搜索到所有要包含的库文件，在程序中总会存在动态加载模块或者是外部库的情况，而这些情况`pyinstaller`都无法发现，对于这种问题目前只能手动去将这些文件添加到配置文件，对于一些流行的库会有人根据踩的坑写好hook文件，但对于没有hook的库就只能自己摸黑弄了。

`Nuika`则似乎更为复杂，它不仅是将搜索到的库打包起来，还会对其进行编译以缩减文件大小、提高效率，由于其比`pyinstaller`做的事更多，自然也有更多的坑和会出问题的地方了。

这里对于`pyinstaller`和`Nuika`的优劣不再多谈，只是我的需求只是想要打包出一个开箱即用的应用，无论是编译还是只打包特定的文件都不在我的需求当中，从另一方面说，我甚至只是需要一个portable的Python环境，然后可以直接运行我的项目就可以了，其它什么都不需要。关于这方面在网上搜索得到的资料依旧很少，一个似乎Portable的`WinPython`好像又无法安装外部库，不禁让人感叹这么一个理论上很简单的需求居然都没有人解决，甚至让人想骂Python。

不过后来在一个神奇的Quora帖子中看到了[pynsist](https://github.com/takluyver/pynsist)这样一个项目，也是打包的工具，其思想就和我上面所说的基本一样，只需要在配置文件里面将依赖的库全部都列出来，打包时也将所有库和一个嵌入的python环境全部打包，简单又不会失败，在几次尝试之后就成功了。总之，推荐有这个需求的同学使用，我这条不归路也终于走到了头。

在成功打包了项目之后又对如何方便地使用工具进行了思考，首先排除使用命令行的方式，这既不方便且对一般用户的要求有些过高了。对于简单的命令行程序而言最好的方式应该是使用批处理脚本，在Windows中将需要输入的文件拖动到批处理文件之上就可以自动作为参数传递给它，从而避免了用户手动输入路径的需要。不嫌麻烦的话也可以用WPF写一个简单的GUI程序出来，编译版本设为.Net Framework 3.5就基本可以在Win7以上的系统上运行。

至于最后打包出的程序我先release到了[Github](https://github.com/ouromoros/autosub/releases/tag/mk3)上，有时间再试试推广一下吧。
