---
layout: post
title: '如何提取微信聊天记录'
tags: [Other]
categories: [Chinese]
---

在微信使用条款中规定了所有创建的微信账号所有权属于腾讯公司，这曾经是个话题，不过后来也没人关心了。微信一直声称服务器上没有保存用户的任何聊天记录，这很明显是假的，而且这个声明唯一的作用大概就是它可以大大方方地不提供在云上同步聊天记录的功能，然后腾讯依然可以背地里用私人聊天记录训练不可告人目的的神经网络模型。不过这些都没有关系，这篇文章主要简单记录了如何从手机中提取微信聊天记录并解密。

## 获取聊天记录数据库

首先参考[这篇博文](https://bg3iqs.com/security/406/)知道了微信的聊天记录都存储在一个叫`EnMicroMsg.db`的文件中，那么首先的问题就是如何将文件提取出来，苹果手机和已Root的安卓手机都相对简单，我的手机碰巧是一个没有Root的安卓手机，因此采用了相对麻烦的步骤：

1. 使用微信自带的迁移聊天记录功能将数据迁移到了电脑的安卓模拟器中
2. 从安卓模拟器中将数据库文件导出

这里要吐槽一下微信对聊天记录的严防死守，无论是将聊天记录备份到电脑微信客户端还是迁移聊天记录都麻烦的不行，而且可以得到的数据库文件还是加密的，因为这些文件都存储在我们自己的设备上，我想这与其说是保护聊天记录的安全，不如说是防止用户简单地将聊天记录导出从而迁移到其它应用去的措施，很多应用都存在这种恶心的增加用户迁移成本的行为，大概这也是互联网中心化的负面作用之一吧。

## 聊天记录解密

由于这是一个本地数据库，因此它必然是可以破解的，在反编译的手段下其加密使用的密码和方法都一览无余，因此只要持有设备就必然有办法将其解密，无论微信程序员使用了多么复杂的加密方法都无法改变这一个事实。

不过实际上的加密方法较为简单，上面那篇博文中也介绍了密码的构成方式，是由手机的imei号和微信号的uid组成，而得到了密码之后就需要打开数据库读取数据了，这一步出乎意料的麻烦。微信是使用SqlCipher加密的数据库，而我们需要知道加密使用的具体参数才能正确地打开它，不知道为什么网络上的博文大都说要使用什么`sqlcipher.exe`的程序，但这个程序并不正规，似乎只存在于CSDN上。我参考了[这篇博文](https://juejin.im/post/5e52aa026fb9a07cb345e530)使用了Sql Studio打开数据库。

打开数据库之后剩下的事情就简单了，看一看数据库的schema，用查询语句提取出需要的数据导出成csv，然后就可以想做什么做什么...我们终于可以说对自己的聊天记录有了完全的所有权！

## 之后...

得到了聊天记录后我们可以做很多事，比如：

1. 对自己的聊天记录做简单的分析，得到一些有趣的结论（就像网易云年度报告一样，这样说会不会感觉有点无聊了）
2. 永久的将聊天记录以可读的方式存储，作为自己和他人的回忆

如果可以的话我还希望可以尝试利用这些数据做一个自己的聊天Bot，基本的想法是找一个已经在大量语料上训练过的pretrained model，更改一下后用自己的聊天记录简单地训练一下得到一个Bot，即使结果不是特别理想感觉也会很有趣。遗憾的是在网络上并没有找到这样现成的模型，而如果要我自己去调研后写一个的话就是一个很长的故事了......
