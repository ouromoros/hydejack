---
layout: post
title: '如何用计算机生成想要的图片'
tags: [CS]
categories: [Chinese]
comments: true
---



如果你有过大量的时间胡思乱想，或者说你像我一样的话，那么或许你会设想过一台神奇的机器，你只要向它描述自己心中所想的事物，一幅幅生动形象的画作就会从其中自动生成出来，完全不需要复杂的电脑操作与绘画知识，也不需要钱。

可惜的是目前来说这样的机器还不存在，这一点从所有的画手还没有失业这件事情上就可以看出来了，但是至少目前我们已经可以做到类似的事情，尽管我们离实现梦想依旧十分遥远，但至少接近了一小步。下面我将对我个人的一个尝试的过程做一个简单的概括，其中每一节中所包含到的细节与概念的取舍全由我本人判断，也并不遵循任何力求使文章简单易懂而设立的标准，因此对这篇文章中每一段内容的跳过与否也都交予读者本人判断，一个或许会有帮助的准则是：当你觉得自己完全看不懂其中的名词与概念时，跳过那一段以及接下来的若干段就行了，或许以后你会想再回头翻一翻，不过那对现在理解这篇文章里做的事情不重要。

# 我们要做什么

用一句话来说，我们所要做的是告诉计算机去产生一个类型的图片，然后由计算机来自动生成它们。注意，**一个类型**这个措辞在这里是十分笼统的，人像可以是一个类型，动漫图片可以是一个类型，或者是某一个特定的狗的照片也可以是一个类型...幸运的是，这句话依然是对的，不过如果这个类型的选择过于笼统的话，我们可能会遇到一些麻烦，之后会对这个问题进行不是很详细和严格的解释。

如果你细心的话，就会发现我们要做的事情和引言中说的不就是同一件事情吗？是的，它们看起来是同一件事情，但是不，它们之间还有很大的区别，最大的区别主要是**怎样告诉计算机我们需要什么类型的图片**和**怎样生成这样的图片**，其中后者对于使用者来说一般都不太关心，但前者就很重要了。一般来说我们会想直接“告诉”计算机需要怎样的图片，但是，*和一台计算机说话？*，至少现在不行。在这篇文章中我们使用的是一个十分粗暴但也至少有道理的方法：给计算机塞一大堆图片，让它自己搞清楚我们想要的是怎样的图片。是的，这就是我们要做的，如果你不感兴趣或是觉得无聊的话，那么现在就是最好的退出时机，因为接下来将全都是对其中细节的阐述。

# 一大堆图片

## 输入图片的影响

在进入更多细节之前我还想对我们使用的方法所存在的一些较为显然的特性做一些补充。首先由于它本身的简单性，我们可以很容易地判断出来在这样一个方法中所提供的图片决定了计算机产生的结果，为了简化表达，我们将提供的图片称为输入图片，计算机产生的结果称为输出图片，我们可以很自然地猜测出下面两点：
- 输入图片越多，得到的输出图片质量越好。
- 输入图片的类型决定了输出图片的类型。

进一步的，聪明的你应该能够看出来，如果输入图片的类型决定了输出图片的类型，那么是否意味着输出图片将和输入图片几乎一模一样？理论上说这是要达到最优解所不可避免的结果，但在实际运行我们采用了一些技巧让计算机*很难*做到这样的事情，因此计算机便只能尽其所能生成和输入图片*一个类型*的图片，虽说问题已经解决了，但这其中潜藏了一个悖论：我们到底要如何定义*一个类型*的图片？我们这里的方法可以和常见的中学题类比：给出了数列的前n项，然后由解题者找出规律以求得数列的通项，但这个方法是有风险的，给出了任意n个数字，都可以有无数个n+1次方程可以是它的生成函数，也就是说，除非给出了数列的所有项，否则我们永远无法确定自己找到的规律是*对的*。

不过就像中学时我们很普通地解开了数列题一样，在这里我们依旧不会被它困扰到，背后的基本原理是奥卡姆剃刀法则——这里就不再赘述了。

从数列的类比中我们还可以得到另一个有用的结论，那就是**规律越复杂，需要的信息越多**。正如复杂的数列需要给出很多项才能让人找出规律一样，如果要生成的图片类型非常复杂——包含各种各样不同事物与背景的话，我们所提供的输入图片的数量也需要更大，以包括这各种各样的事物与背景（至少一部分）。

## 获取输入图片

要想得到好的结果，我们将需要大量的输入图片。一般来说，就算只想生成*手写数字*那么简单的事物，也需要一万张左右的输入图片，而这是超出大部分人个人能力的（手动去拍摄或制作）。一般来说只有两种方式：从一些渠道获取图片集或自己去收集图片集。在我实验中是使用爬虫从一个网站上爬取了几万张图片，但效果依旧不是很理想，下面简单地对爬虫的实现做一些叙述。（无编程经验者可以跳过此节以免造成不必要的压力）

一般来说，爬虫的工作方式是从一个网页出发，然后从该网页中得到其它网页的链接，再进入其它网页得到更多的网页链接...这样一步步将整个网站中的所有内容*爬取*下来，由于大网站许多都有反爬虫措施，当你的流量存在异常时就会暂时屏蔽你的IP（比如说你在十分钟内访问了一千个网页），而对于小网站来说其网页链接往往较为简单，很多时候可以通过改变一部分达到*遍历*网站内容的目的，而不需要使用前面叙述的*递归*的方式。

出于方便的目的，Python一般用于写这类简单的爬虫程序，由于瓶颈是IO，因此语言本身的性能并不是特别重要。我写爬虫程序时首先使用Chrome中的网页元素查看功能分析链接，然后使用Python发出网络请求、分析HTML内容、下载资源等操作。一般来说要最大化网络带宽利用率的话需要使用多线程编程，就爬虫来说一般使用轻量级的线程库，这样可以达到同时下载几百个图片的目的。（我使用到的Python库有requests、beautifulsoup、gevent）

# 怎样生成图片

生成图片是一件一眼看上去有些无从下手的事情，要明白如何让计算机生成一张图片，首先我们需要探究计算机中图片的表示方式，图片的最简单的表示方式是由一个二维数组——或者说是由一个NxM大小的点阵表示的，其中每一个点表示对应的像素颜色，一般由一个整数（黑白图片）或者三个整数（RGB）表示。现在的显示屏一个常见的分辨率是1600x900，即一共有1440000个像素点，即1440000或者3320000个整数。生成这么多个整数显然是一件很难的事情，更何况我们的目的是生成一张*图片*，而不是没有规律的噪点。幸运的是在机器学习领域中已经有人发明了一个生成任意数量整数的模型了，它就是人工神经网络。

人工神经网络是一个看起来比实际上要更难懂的名词，它的名字来源于其最初受了神经元之间的工作方式的启发，但就现在的发展而言已经很少有人关心其原本的起源了。就最简单的理解方式来说，我们可以把一个人工神经网络想象成一个黑箱，它接收任意个数量的数字输入，然后生成任意个数量的数字输出。当然，人工神经网络的内部也有许许多多不同的结构，不过要讲清楚它们的话我再写一篇文章也不一定有用。

可是一个这样的黑箱有什么用呢？我知道我给它提供几个数字它就会给我返回几个数字，但这有什么意义？确实如果只是这样的话，那黑箱不会对任何人产生任何作用，不过显然既然我们提到了它，它就至少有一点用...确实一个单纯的黑箱对我们不会有任何用途，但一个人工神经网络是可以调整的，你可以通过改变其内部的结构来调整它的输入输出，想象一下，就像调收音机一样，起初只有无意义的噪声，但只要你调到那个正确的点，一切就都豁然开朗了。就这里的情况来说，理论上在一个合适的人工神经网络上可以调整出任意输入与输出的对应关系，比如说你可以将输入设为一个问题的计算机编码，将输出设为对应的答案的编码，然后...下一步或许就是得到生命、宇宙以及一切的答案了，当然实际上这样做会遇到困难，不过理解意思就行了，人工神经网络是一个泛用性很强的工具。

就我们生成图片来说，我们并不在意输入是什么——它们可以是随便什么，我们只在意输出。我们希望输出里只有我们所期望的类型的图片而不是别的什么，这就又回到收音机的比喻了，我们并不在意具体的频率是什么，只希望结果是清晰的、有意义的广播。

在实际中调整人工神经网络不会像调整收音机那样简单，里面可能会有上万、上亿个参数，但同时也有许多专门用于调整其参数以达到目标的方法，它们都或多或少是有作用的，尽管有时我们无法调整出最理想的网络，但很多时候都能得到一个足够好的人工神经网络模型。

要训练出我们希望的人工神经网络并不是一件容易的事情，尤其我们不限定输入的情况下。如果希望生成某一类型的图片，那么首先我们需要知道这一类型的图片是怎样的，而计算机要如何判断一个图片是不是所需要的类型呢...答案是使用人工神经网络！没错，我们要再训练一个人工神经网络来告诉计算机生成的图片是不是我们想要的，实际上这几乎就是著名的生成对抗神经网络(GAN)所蕴含的全部创新思想了。训练的具体过程较为枯燥乏味且我无法解释清楚，因此本文中就略过了。

# 一切完成之后

坏事要留在最后说，这是我在本文中使用的一点小技巧。受限于目前方法的发展，我们使用一块普通的游戏GPU加上10000张左右的图片，只能训练128x128大小的图片——缩略图大小的程度，而且由于我选择的图片集类别有些太笼统了，因此最后训练的结果不太理想...不管怎样一眼看上去似乎有一点那种感觉，这里给各位参考一下。

![dotpict](/assets/img/dotpict.jpg)

![meizi](/assets/img/meizi.jpg)

相信各位在看到图片之后应该大概也差不多能想象使用的图片集是什么，这样就够了，至少我们可以看到效果，不是吗。
